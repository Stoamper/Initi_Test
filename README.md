# Адаптивный алгоритм работы светофоров

<p align="left">
  <img width="700" src="https://logos44.ru/wp-content/uploads/2023/11/1640437874_36-funart-pro-p-foni-so-svetoforami-39.jpeg">
</p>

Адаптивный алгоритм работы светофоров предназначен для оптимизации пропускной способности перекрестка в зависимости от дорожной ситуации.

## Содержание

- [Постановка исходной задачи](#general_task)
- [Принятые допущения](#assumptions)
- [Характеристики адаптивного алгоритма работы светофоров](#algorithms)
- [Описание процесса работы адаптивного алгоритма](#alg_desc)
- [Рекомендации для учета в дальнейших версиях алгоритма](#recs)
- [Вклад](#contributors)

## <a name="general_task"></a> Постановка исходной задачи

Рассмотрим перекресток на рисунке. На нем находится несколько светофоров, регулирующих движение автомобилей (4 шт), и несколько - движение пешеходов по переходам (8 шт).

<p align="left">
  <img width="350" src="https://github.com/Stoamper/Initi_Test/assets/87001138/c35c5c4c-4578-4e00-a1e0-669bc65a5e7b">
</p>


•	У пешеходных светофоров 2 состояния, у автомобильных - 3.

•	В каждый светофор встроена камера, которая фиксирует количество автомобилей/пешеходов в той очереди, для которых светофор установлен. Это очередь на противоположной стороне пешехода/перекрестка.

•	Автомобили при проезде перекрестка едут либо прямо, либо направо.

•	Люди и автомобили осуществляют переход или проезд перекрестка по одному, уменьшая размер соответствующей очереди на 1.

•	Каждый светофор имеет уникальный id.

•	Светофоры могут общаться при помощи событий, отсылая события друг другу по id. Пересылаемые события - это некоторые контейнеры с данными (например, там может лежать количество людей/автомобилей в очереди, id отправителя, текущее состояние светофора).

•	Светофор может взводить таймер, который через заданное время отсылают заданное событие на заданный id.

•	Отправка события - это помещение контейнера в очередь событий для светофора, у каждого светофора очередь своя собственная.

•	Светофоры обрабатывают события параллельно, независимо от друг от друга. При этом каждый светофор обрабатывает свои события последовательно, в том порядке, в каком они помещаются в очередь.

•	Светофор может получить информацию о текущем состоянии любого другого светофора синхронно (не через событие).

**Необходимо** придумать и описать адаптивный алгоритм работы светофоров для оптимизации общей пропускной способности перекрестка в зависимости от ситуации на перекрестке.


## <a name="assumptions"></a> Принятые допущения

•	В исходной задаче указано, что автомобили при проезде перекрестка едут либо прямо, либо направо. Это значит, что можно синхронизировать работу автомобильных светофоров вдоль одной дороги (улицы). Если бы автомобилям надо было поворачивать налево, то пришлось бы закладывать время выдержки для пропускания потока.

•	Работу пешеходных светофоров, расположенных друг напротив друга в рамках одного пешеходного перехода, также необходимо синхронизовать (в моменте оба должны показывать либо зеленый свет, либо красный).

•	Условно принимаем, что дорога за перекрестком свободная, отсутствуют заторы.

•	Водители и пешеходы соблюдают ПДД.


## <a name="algorithms"></a> Характеристики адаптивного алгоритма работы светофоров

### Общие сведения

Пропускная способность перекрестка представляет собой количество автомобилей, которые могут пройти перекресток за определенную единицу времени. 

В рамках представленной задачи рассматриваются следующие варианты дорожной обстановки:

1. Нормальная загрузка (количество автомобилей и пешеходов в очередях не превышает заданного среднего значения);
2. Повышенное количество пешеходов по одному / нескольким переходам;
3. Повышенное количество автомобилей по одной дороге;
4. Повышенное количество автомобилей по одной дороге и пешеходов по одному / нескольким переходам;
5. Час пик;
6. Ночной режим;
7. Аварийная ситуация.

Каждый из этих вариантов со своими особенностями и вариантами работы светофоров более подробно описывается в следующем подразделе.


### Детальная информация о характеристиках

Определим следующие переменные, которые будут характеризовать дорожную ситуацию:

•	n_a<sub>min</sub> – минимальное количество автомобилей, проходящее по одной из дорог;

•	n_a<sub>avg</sub> – среднее количество автомобилей, проходящее по одной из дорог;

•	n_a<sub>cur</sub> – текущее количество автомобилей, проходящее по одной из дорог (зафиксировано камерой);

•	n_p<sub>min</sub> – минимальное количество пешеходов, проходящих через одну из дорог;

•	n_p<sub>avg</sub> – среднее количество пешеходов, проходящих через одну из дорог;

•	n_p<sub>cur</sub> – текущее количество пешеходов, проходящих через одну из дорог (зафиксировано камерой);

•	t_a<sub>avg</sub> – среднее время работы автомобильного светофора;

•	t_a<sub>max</sub> – максимальное время работы автомобильного светофора;

•	t_p<sub>avg</sub> – среднее время работы пешеходного светофора;

•	t_p<sub>max</sub> – максимальное время работы пешеходного светофора.


| № | Режим | Характеристики | Описание | Работа автомобильных светофоров | Работа пешеходных светофоров |
| ------- | ------- | ------- | ------- | ------- | ------- |  
| 1 | Нормальная нагрузка | Все дороги n_a<sub>cur</sub> <= n_a<sub>avg</sub>;<br> Все переходы n_p<sub>cur</sub> <= n_p<sub>avg</sub> | Данный вариант дорожной обстановки характеризуется нормальной загруженностью дороги, когда количество автомобилей/пешеходов в очереди не превышает заранее заданной величины n_a<sub>avg</sub>. Для него устанавливаются стандартные значения времени работы светофоров (t_a<sub>avg</sub> для автомобильных и t_p<sub>avg</sub> для пешеходных) | Работают по заданному стандартному таймеру t_a<sub>avg</sub> в обоих направлениях | Работают по заданному стандартному таймеру t_p<sub>avg</sub> в обоих направлениях. При этом t_p<sub>avg</sub> < t_a<sub>avg</sub>. Это сделано для того, чтобы часть времени пешеходы не создавали помехи и автомобили могли беспрепятственно повернуть направо |
| 2 | Повышенное количество пешеходов по одному / нескольким переходам | Все дороги n_a<sub>cur</sub> <= n_a<sub>avg</sub>; <br> Один / несколько переходов n_p<sub>cur</sub> > n_p<sub>avg</sub> | При увеличении количества пешеходов по одному / нескольким переходам необходимо увеличить пропускную способность конкретных мест | Работают по заданному стандартному таймеру t_a<sub>avg</sub> в обоих направлениях | В том направлении, где обнаружена необходимость увеличения пропускной способности переходов, время работы светофоров увеличивается и становится равным времени работы автомобильных светофоров (то есть до t_a<sub>avg</sub>). На тех переходах, где отсутствует необходимость в увеличении пропускной способности светофоры продолжают работать по заданному стандартному таймеру t_p<sub>avg</sub> < t_a<sub>avg</sub> чтобы не создавать помех автомобилям |  
| 3 | Повышенное количество автомобилей по одной дороге | Одна дорога n_a<sub>cur</sub> > n_a<sub>avg</sub>;<br> Все переходы n_p<sub>cur</sub> <= n_p<sub>avg</sub> | При увеличении количества автомобилей, движущихся по одной дороге, необходимо увеличить пропускную способность только в одном направлении | В том направлении, где обнаружено увеличение количества автомобилей выше среднего значения повышается время работы зеленого сигнала с t_a<sub>avg</sub> до t_a<sub>max</sub>. Соответственно, на другой дороге увеличивается время простоя автомобилей на красный сигнал | Работают по заданному стандартному таймеру t_p<sub>avg</sub> в обоих направлениях. При этом t_p<sub>avg</sub> < t_a<sub>avg</sub>. Это сделано для того, чтобы часть времени пешеходы не создавали помехи и автомобили могли беспрепятственно повернуть направо | 
| 4 | Повышенное количество автомобилей по одной дороге и пешеходов по одному / нескольким переходам | Одна дорога n_a<sub>cur</sub> > n_a<sub>avg</sub>;<br> Один переход n_p<sub>cur</sub> > n_p<sub>avg</sub> | При увеличении количества автомобилей, движущихся по одной дороге, и пешеходов необходимо увеличить пропускную способность в одном направлении для автомобилей и одном / нескольких переходах | В том направлении, где обнаружено увеличение количества автомобилей выше среднего значения повышается время работы зеленого сигнала с t_a<sub>avg</sub> до t_a<sub>max</sub>. Соответственно, на другой дороге увеличивается время простоя автомобилей на красный сигнал | В том направлении, где обнаружена необходимость увеличения пропускной способности переходов, время работы светофоров увеличивается и становится равным времени работы автомобильных светофоров (то есть t_p<sub>max</sub> = t_a<sub>avg</sub>). На тех переходах, где отсутствует необходимость в увеличении пропускной способности светофоры продолжают работать по заданному стандартному таймеру t_p<sub>avg</sub> < t_a<sub>avg</sub> чтобы не создавать помех автомобилям |  
| 5 | Час пик | Все дороги n_a<sub>cur</sub> > n_a<sub>avg</sub>;<br> Все переходы n_p<sub>cur</sub> > n_p<sub>avg</sub> | При данном варианте дорожной обстановки полностью меняется режим работы светофоров. Теперь зеленый сигнал для пешеходов горит только тогда, когда для всех автомобилей красный. Благодаря этому пешеходы не мешают поворачивающим направо автомобилям, тем самым повышается пропускная способность автомобильной дороги | В обоих направлениях у увеличивается время зеленого сигнала светофора с t_a<sub>avg</sub> до t_a<sub>max</sub>. Когда на пешеходных светофорах зеленый сигнал, то оба автомобильных показывают красный | Для работы всех пешеходных светофоров отводится отдельное время t_p<sub>max</sub> = t_a<sub>avg</sub>. При этом t_p<sub>max</sub> < t_a<sub>max</sub> чтобы не сильно задерживать автомобильный поток | 
| 6 | Ночной режим | Все дороги n_a<sub>cur</sub> -> 0;<br> Все переходы n_p<sub>cur</sub> -> 0 | Практически полное отсутствие транспортных средств и пешеходов. При таком режиме светофоры перестают работать и обмениваться событиями. Переход к ночному режиму осуществляется после установленного времени суток, а также при условии отсутствия большого транспортных средств (менее n_amin, которая закладывается программно) | Работают в режиме нерегулируемого перекрестка (желтый мигающий). Проезд согласно знакам приоритета | Отключены. Проход по пешеходному переходу согласно ПДД | 
| 7 | Аварийная ситуация | Отсутствуют | Аварийная ситуация возникает при каких-либо нештатных обстоятельствах (отключение света, поломка светофора и т.п.) | Работают в режиме нерегулируемого перекрестка (желтый мигающий). Проезд согласно знакам приоритета | Отключены. Проход по пешеходному переходу согласно ПДД |    

В целом алгоритмы работы светофоров в большей степени ориентированы на оптимизацию *автомобильного потока*, поскольку в первую очередь город должен ехать.

### Циклограммы работы светофоров

Циклограммы - это диаграммы, показывающие время и последовательность выполнения операций в процессе. В данном репозитории приложены [циклограммы работы светофоров]().

**Краткое пояснение:**

•	на циклограммах показан порядок работы автомобильных и пешеходных светофоров в рамках выбранного цикла;

•	цвет ячеек соответствует сигналу светофора;

•	отрезки времени, длительность работы светофоров условные.

<p align="left">
  <img width="500" src="https://github.com/Stoamper/Initi_Test/assets/87001138/d8104398-c9fb-4fef-bcf2-7e26a472a7b8">
</p>


## <a name="alg_desc"></a> Описание процесса работы адаптивного алгоритма

Адаптивный режим работы предусматривает возможность корректировки режимов работы светофоров в зависимости от текущей дорожной ситуации. Для достижения наибольшей эффективности фиксация количества автомобилей/пешеходов должна выполняться постоянно.

Рассмотрим некоторые примеры, содержащие описание адаптивных алгоритмов работы светофоров. Для удобства каждому светофору присовим уникальный id. Также объединим пары светофоров, которые относятся к одной дороге и одному пешеходному переходу.

<p align="left">
  <img width="350" src="https://github.com/Stoamper/Initi_Test/assets/87001138/52217c9d-b2b1-468b-b83f-bdcf17207ab2">
</p>

Цикл работы светофоров начинается с режима «Нормальная нагрузка». Условно принимаем, что первыми включаются в работу автомобильные светофоры id5_1-id5_2, пешеходные светофоры id2_1-id2_2, id4_1, id4_2. После того, как они переключаются на красный работают автомобильные светофоры id6_1-id6_2, пешеходные светофоры id1_1-id1_2, id3_1-id3_2.

Светофор с красным сигналом считывает количество автомобилей/пешеходов в очереди. В зависимости от количества автомобилей/пешеходов светофоры рассылают информацию на другие о том, какой длительности будет следующий цикл (время красного сигнала светофора, время зеленого сигнала светофора). Автомобильные светофоры общаются между собой, а пешеходные между собой во всех случаях, кроме режима «Час пик»: в таком случае автомобильные дополнительно сообщают пешеходным, что они не должны работать если хотя бы один из автомобильных светофоров горит зеленым светом.

Заложенный в работу светофора механизм синхронного получения информации о состоянии любого другого светофора необходим для обеспечения безопасности их совместной работы (например, чтобы на пересекающихся дорогах не было сразу двух зеленых сигналов светофора, так как это может привести к возникновению аварийной ситуации).

Для примера рассмотрим варианты перехода с одного режима работы на другой.

**1.	Переход с режима «Нормальная нагрузка» на «Повышенное количество автомобилей по одной дороге»**

Во время текущего цикла в режиме «Нормальная нагрузка» одна из камер пары автомобильных светофоров id5_1-id5_2 установила, что количество автомобилей в очереди стало превышать среднее значение (n_a<sub>cur</sub> > n_a<sub>avg</sub>). Для увеличения времени работы светофора в режиме зеленого сигнала была отправлена информация об увеличении времени до t_a<sub>max</sub>. 

![2024-03-11_11-56-16 (2)](https://github.com/Stoamper/Initi_Test/assets/87001138/3d3f4004-5bd7-4ed6-b273-67daeecebafb)

Также увеличилось время работы автомобильного светофора id6_1-id6_2 в режиме красного сигнала на пересекающейся дороге. Работа пешеходных светофором не изменилась. Итоговый цикл работы выглядит следующим образом:

![2024-03-11_12-00-34 (2)](https://github.com/Stoamper/Initi_Test/assets/87001138/8a5e1c05-bc1b-4513-a1df-130b102f327f)

**2.	Переход с режима «Повышенное количество автомобилей по одной дороге» на «Час пик»**

Во время текущего цикла в режиме «Повышенное количество автомобилей по одной дороге» камерами пар автомобильных светофоров id5_1-id5_2 и id6_1-id6_2 было установлено, что количество автомобилей в очередях стало превышать среднее значение (n_a<sub>cur</sub> > n_a<sub>avg</sub>). Для увеличения времени работы светофора в режиме зеленого сигнала была отправлена информация об увеличении времени до t_a<sub>max</sub>. 

![2024-03-11_12-03-14 (2)](https://github.com/Stoamper/Initi_Test/assets/87001138/edef250d-822d-40b1-b8ed-32fa0995b11e)

![2024-03-11_12-06-03 (3)](https://github.com/Stoamper/Initi_Test/assets/87001138/85f26853-3d9e-423f-b73a-6c16fc1aa1c8)

Итоговый цикл работы выглядит следующим образом:

<p align="left">
  <img width="740" src="https://github.com/Stoamper/Initi_Test/assets/87001138/27eb7ad1-338a-4af2-a504-fbb02f604291">
</p>


## <a name="recs"></a> Рекомендации для учета в дальнейших версиях алгоритма

* По заданию светофоры "общаются" между собой. Предлагается рассмотреть возможность отправки события не на светофор, а в определенную программу. На основе собранных данных эта программа будет направлять события на каждый из светофоров (то есть решения будут приниматься централизованно). Это позволит упростить взаимодействие между светофорами.
* Для конкретного перекрестка можно собрать статистику по количеству автомобилей и пешеходов в разное время дня. В зависимости от загруженности можно ставить заранее написанные циклы без необходимости ежеминутного контроля количества автомобилей/пешеходов.
* В описанном алгоритме время работы равно либо стандартному значению (при нормальной нагрузке), либо максимальному (при повышенной). Допускается сделать более точную градацию в зависимости от потока автомобилей/пешеходов (например, трех- или четырехступенчатую).
* На тех перекрестках, где ночной режим не уместен (постоянный поток) можно в ночное время оставлять режим нормальной нагрузки.


## <a name="contributors"></a> Вклад


Этот проект существует благодаря всем, кто вносит вклад:\
[Stoamper](https://gitlab.com/Stoamper)
